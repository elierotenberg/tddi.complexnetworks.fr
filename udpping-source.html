<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>stdio.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>stdlib.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>string.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>unistd.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>errno.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>sys/types.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>time.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>math.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>assert.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>signal.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>fcntl.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>arpa/inet.h</span><span style='color:#800000; '>></span>

<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> __FAVOR_BSD 1</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>netinet/ip.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>netinet/ip_icmp.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>netinet/udp.h</span><span style='color:#800000; '>></span>

<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>int</span> uint32<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>short</span> uint16<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>char</span> uint8<span style='color:#800080; '>;</span>

<span style='color:#696969; '>/* initial sending ttl */</span>
uint8 ttl <span style='color:#808030; '>=</span> <span style='color:#008c00; '>255</span><span style='color:#800080; '>;</span>

<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> PACKET_SIZE 1000</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> STR_SIZE 1000</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> default_msg </span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>UDP Ping</span><span style='color:#800000; '>"</span>

<span style='color:#800000; font-weight:bold; '>char</span> msg<span style='color:#808030; '>[</span>STR_SIZE<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>

<span style='color:#696969; '>/* delay (in seconds) to wait after sending all packets (answers may still arrive) */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> FINAL_DELAY 60</span>

<span style='color:#800000; font-weight:bold; '>int</span> source_port<span style='color:#808030; '>,</span> target_port<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>int</span> verbose <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>int</span> packet_to_read <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>

<span style='color:#696969; '>/* blocking but may be interrupted by the arrival of an ICMP packet (or any signal) */</span>
<span style='color:#800000; font-weight:bold; '>int</span> send_udp_ping<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> udp_sock<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>target<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
 <span style='color:#800000; font-weight:bold; '>struct</span> sockaddr_in target_addr<span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>char</span> packet<span style='color:#808030; '>[</span>PACKET_SIZE<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>struct</span> ip <span style='color:#808030; '>*</span>iph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>packet<span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>struct</span> udphdr <span style='color:#808030; '>*</span>udph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> udphdr <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span>packet<span style='color:#808030; '>+</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>int</span> msglen <span style='color:#808030; '>=</span> <span style='color:#603000; '>strlen</span><span style='color:#808030; '>(</span>msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 <span style='color:#603000; '>memset</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span>target_addr<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>target_addr<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#603000; '>memset</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>packet<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> PACKET_SIZE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 target_addr<span style='color:#808030; '>.</span>sin_family <span style='color:#808030; '>=</span> AF_INET<span style='color:#800080; '>;</span>
 target_addr<span style='color:#808030; '>.</span>sin_port <span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span>target_port<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 assert<span style='color:#808030; '>(</span>inet_aton<span style='color:#808030; '>(</span>target<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>target_addr<span style='color:#808030; '>.</span>sin_addr<span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 assert<span style='color:#808030; '>(</span><span style='color:#400000; '>connect</span><span style='color:#808030; '>(</span>udp_sock<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> <span style='color:#400000; '>sockaddr</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span>target_addr<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> sockaddr_in<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_v <span style='color:#808030; '>=</span> <span style='color:#008000; '>0x4</span><span style='color:#800080; '>;</span>
 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_hl <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span> <span style='color:#808030; '>></span><span style='color:#808030; '>></span> <span style='color:#008c00; '>2</span><span style='color:#800080; '>;</span>
 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_tos <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_len <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> udphdr<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> msglen<span style='color:#800080; '>;</span>
 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_ttl <span style='color:#808030; '>=</span> ttl<span style='color:#800080; '>;</span>
 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_off <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_p <span style='color:#808030; '>=</span> IPPROTO_UDP<span style='color:#800080; '>;</span>
 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_sum <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_src<span style='color:#808030; '>.</span>s_addr <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_dst<span style='color:#808030; '>.</span>s_addr <span style='color:#808030; '>=</span> target_addr<span style='color:#808030; '>.</span>sin_addr<span style='color:#808030; '>.</span>s_addr<span style='color:#800080; '>;</span>

 <span style='color:#696969; '>/* store information to recognise answer packets */</span>
 iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_id <span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span><span style='color:#808030; '>(</span>uint16 <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span><span style='color:#808030; '>(</span>iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_dst<span style='color:#808030; '>.</span>s_addr<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>^</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>(</span>uint16 <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span><span style='color:#808030; '>(</span>iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_dst<span style='color:#808030; '>.</span>s_addr<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_sport <span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span>source_port<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_dport <span style='color:#808030; '>=</span> target_addr<span style='color:#808030; '>.</span>sin_port<span style='color:#800080; '>;</span>
 udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_ulen <span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>uint16<span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> udphdr<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> msglen<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_sum <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>

 <span style='color:#603000; '>strcpy</span><span style='color:#808030; '>(</span>packet<span style='color:#808030; '>+</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> udphdr<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span>write<span style='color:#808030; '>(</span>udp_sock<span style='color:#808030; '>,</span>packet<span style='color:#808030; '>,</span>iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_len<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#800080; '>}</span>

<span style='color:#696969; '>/* do as little things as possible in a signal handler, *</span>
<span style='color:#696969; '>&#xa0;* in particular avoid function calls to printf etc     */</span>
<span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#400000; '>Handler</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> signalType<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
 packet_to_read <span style='color:#808030; '>=</span> signalType<span style='color:#800080; '>;</span>
 <span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>char</span> byte<span style='color:#800080; '>;</span>

<span style='color:#800000; font-weight:bold; '>inline</span> <span style='color:#800000; font-weight:bold; '>long</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>long</span> ip0<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>long</span> ip1<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>long</span> ip2<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>long</span> ip3<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
  <span style='color:#800000; font-weight:bold; '>return</span> ip0<span style='color:#808030; '>*</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>256</span> <span style='color:#808030; '>+</span> ip1<span style='color:#808030; '>*</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>256</span> <span style='color:#808030; '>+</span> ip2<span style='color:#808030; '>*</span><span style='color:#008c00; '>256</span> <span style='color:#808030; '>+</span> ip3<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>inline</span> <span style='color:#800000; font-weight:bold; '>long</span> long_from_bytep<span style='color:#808030; '>(</span>byte <span style='color:#808030; '>*</span>ip<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
  <span style='color:#800000; font-weight:bold; '>return</span> long_from_ints<span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>


<span style='color:#800000; font-weight:bold; '>inline</span> <span style='color:#800000; font-weight:bold; '>int</span> in_interval<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>long</span> i<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>long</span> imin<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>long</span> imax<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
  <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>(</span>i <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> imin <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> i <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> imax<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>int</span> is_valid<span style='color:#808030; '>(</span>byte <span style='color:#808030; '>*</span>ip<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>14</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>39</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>127</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>128</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>169</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>254</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>172</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>31</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>191</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>192</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>192</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>192</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>88</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>99</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>192</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>168</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>192</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>18</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>19</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>223</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>224</span><span style='color:#808030; '>)</span>
    <span style='color:#696969; '>/* Corresponds to multicast (former class D networks), */</span>
    <span style='color:#696969; '>/* first octet between 224 and 239, */</span>
    <span style='color:#696969; '>/* and reserved (former class E networks), */</span>
    <span style='color:#696969; '>/* first octet between 240 and 255 */</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

  <span style='color:#696969; '>// PlanetLab blacklist below</span>

  <span style='color:#800000; font-weight:bold; '>long</span> i <span style='color:#808030; '>=</span> long_from_bytep<span style='color:#808030; '>(</span>ip<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>63</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>215</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>104</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>63</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>215</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>107</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>67</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>210</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>80</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>67</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>210</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>95</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>74</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>202</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>16</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>74</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>202</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>19</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>207</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>174</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>77</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>207</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>174</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>77</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>207</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>174</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>98</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>207</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>174</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>98</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>207</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>174</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>114</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>207</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>174</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>114</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>207</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>174</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>173</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>207</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>174</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>173</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>207</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>174</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>210</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>207</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>174</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>211</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>63</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>214</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>32</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>63</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>214</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>39</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>63</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>215</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>108</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>63</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>215</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>111</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>64</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>74</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>187</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>64</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>74</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>187</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>199</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>45</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>166</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>199</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>45</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>166</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>in_interval<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>199</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>45</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>240</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> long_from_ints<span style='color:#808030; '>(</span><span style='color:#008c00; '>199</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>45</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>240</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>

  <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>int</span> get_packets<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> icmp_sock<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> sockaddr_in r_addr<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> ip <span style='color:#808030; '>*</span>r_iph<span style='color:#808030; '>,</span> <span style='color:#808030; '>*</span>s_iph<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> icmphdr <span style='color:#808030; '>*</span>r_icmph<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> udphdr <span style='color:#808030; '>*</span>s_udph<span style='color:#800080; '>;</span>
  socklen_t len<span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>int</span> type<span style='color:#808030; '>,</span> code<span style='color:#800080; '>;</span>
 ssize_t r_size<span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>int</span> n <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>char</span> packet<span style='color:#808030; '>[</span>PACKET_SIZE<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>do</span><span style='color:#800080; '>{</span>
  len <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>socklen_t<span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>r_addr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  r_size <span style='color:#808030; '>=</span> <span style='color:#400000; '>recvfrom</span><span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>packet<span style='color:#808030; '>,</span> PACKET_SIZE<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> <span style='color:#400000; '>sockaddr</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span>r_addr<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>len<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>r_size<span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>ICMP packet (</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> bytes from </span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '>).</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span><span style='color:#808030; '>)</span>r_size<span style='color:#808030; '>,</span><span style='color:#400000; '>inet_ntoa</span><span style='color:#808030; '>(</span>r_addr<span style='color:#808030; '>.</span>sin_addr<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
   <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>+</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
   <span style='color:#603000; '>fflush</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>r_size <span style='color:#808030; '>&lt;</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> icmphdr<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Packet too small.</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
   <span style='color:#800000; font-weight:bold; '>else</span><span style='color:#800080; '>{</span>
    r_iph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>packet<span style='color:#800080; '>;</span>
    assert<span style='color:#808030; '>(</span>r_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_p<span style='color:#808030; '>=</span><span style='color:#808030; '>=</span>IPPROTO_ICMP<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    r_icmph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> icmphdr <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>r_iph<span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>r_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_hl<span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    type <span style='color:#808030; '>=</span> r_icmph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>type<span style='color:#800080; '>;</span>
    code <span style='color:#808030; '>=</span> r_icmph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>code<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>switch</span> <span style='color:#808030; '>(</span>type<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
     <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>ICMP_TIME_EXCEEDED</span><span style='color:#e34adc; '>:</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '> ICMP_TIME_EXCEEDED</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>ICMP_ECHOREPLY</span><span style='color:#e34adc; '>:</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '> ICMP_ECHOREPLY</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>ICMP_DEST_UNREACH</span><span style='color:#e34adc; '>:</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '> ICMP_DEST_UNREACH </span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>code<span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>unknown code (</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>).</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span>code<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
       <span style='color:#800080; '>}</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>port unreachable</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>*</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      s_iph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>r_icmph<span style='color:#808030; '>+</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> icmphdr<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      s_udph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> udphdr <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>s_iph<span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>s_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_hl<span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '> from </span><span style='color:#0f69ff; '>%s</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span><span style='color:#400000; '>inet_ntoa</span><span style='color:#808030; '>(</span>r_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_src<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>, initially </span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '>. </span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span><span style='color:#400000; '>inet_ntoa</span><span style='color:#808030; '>(</span>s_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_dst<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>s_udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_dport <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span>target_port<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Packet not for us (invalid target port).</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>-</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
       <span style='color:#800080; '>}</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>s_udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_sport <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span>source_port<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Packet not for us (invalid source port).</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>-</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
       <span style='color:#800080; '>}</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span> <span style='color:#400000; '>ntohs</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span><span style='color:#808030; '>(</span>uint16 <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span><span style='color:#808030; '>(</span>s_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_dst<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>^</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>(</span>uint16 <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span><span style='color:#808030; '>(</span>s_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_dst<span style='color:#808030; '>.</span>s_addr<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> s_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_id <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Inconsistent packet (IP id).</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>-</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
       <span style='color:#800080; '>}</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Packet is for us and consistent. Success.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#603000; '>fflush</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stdout</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%s</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span><span style='color:#400000; '>inet_ntoa</span><span style='color:#808030; '>(</span>r_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_src<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stdout</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '> </span><span style='color:#0f69ff; '>%s</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span><span style='color:#400000; '>inet_ntoa</span><span style='color:#808030; '>(</span>s_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_dst<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#603000; '>fflush</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stdout</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      n<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
<span style='color:#e34adc; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#800000; font-weight:bold; '>default</span><span style='color:#e34adc; '>:</span>
      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Unknown type.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
     <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
   <span style='color:#800080; '>}</span>
  <span style='color:#800080; '>}</span><span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span>r_size<span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span>n<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>void</span> usage<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>cmde<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
 <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '> reads IP addresses (text dotted representation, one address per line) on its standard input, and sends a UDP packet to them. It displays information (sender and coresponding target) on the corresponding ICMP port unreachable packets it receives.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span>cmde<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Usage:</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '> </span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '> [-v] [-p port] [-d delay]</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> cmde<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '> -v: verbose mode.</span><span style='color:#0f69ff; '>\n</span><span style='color:#0000e6; '> -p port: target port (if unspecified, a random port is used).</span><span style='color:#0f69ff; '>\n</span><span style='color:#0000e6; '> -d delay: number of milliseconds between two packets.</span><span style='color:#0f69ff; '>\n</span><span style='color:#0000e6; '> -h: this help.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Warning: if delay is too small (machine dependent) the program may overflow the network.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#603000; '>exit</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>int</span> <span style='color:#400000; '>main</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> argc<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>argv<span style='color:#808030; '>[</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
 <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>int</span> one <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>struct</span> sigaction handler<span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>char</span> c<span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>long</span> <span style='color:#800000; font-weight:bold; '>int</span> n_try<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> n_sent<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> n_ok<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>int</span> icmp_sock<span style='color:#808030; '>,</span> udp_sock<span style='color:#808030; '>,</span> foo_sock<span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>char</span> target<span style='color:#808030; '>[</span>STR_SIZE<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>int</span> linesize<span style='color:#808030; '>=</span>STR_SIZE<span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>char</span> line<span style='color:#808030; '>[</span>linesize<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
 byte ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>int</span> ipint<span style='color:#808030; '>[</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>int</span> lgr<span style='color:#808030; '>,</span> i<span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>int</span> delay <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1000000</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>/* in microseconds */</span>
 <span style='color:#800000; font-weight:bold; '>struct</span> timespec req<span style='color:#808030; '>,</span> rem<span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>int</span> flags<span style='color:#800080; '>;</span>
 <span style='color:#603000; '>sprintf</span><span style='color:#808030; '>(</span>msg<span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%s</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> default_msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 source_port <span style='color:#808030; '>=</span> <span style='color:#008c00; '>49152</span> <span style='color:#808030; '>+</span> random<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>%</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>65535</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>49152</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>uint8<span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>uint16<span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>uint32<span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 srandom<span style='color:#808030; '>(</span>getpid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 assert<span style='color:#808030; '>(</span>RAND_MAX<span style='color:#808030; '>></span><span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 <span style='color:#696969; '>/* set up target port number (command-line argument or random) */</span>
 target_port <span style='color:#808030; '>=</span> <span style='color:#008c00; '>49152</span> <span style='color:#808030; '>+</span> random<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>%</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>65535</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>49152</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>=</span>getopt<span style='color:#808030; '>(</span>argc<span style='color:#808030; '>,</span>argv<span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>hvp:d:m:</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span>
  <span style='color:#800000; font-weight:bold; '>switch</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
   <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'v'</span><span style='color:#e34adc; '>:</span>
    verbose <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
   <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'p'</span><span style='color:#e34adc; '>:</span>
    target_port <span style='color:#808030; '>=</span> <span style='color:#603000; '>atoi</span><span style='color:#808030; '>(</span>optarg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
   <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'d'</span><span style='color:#e34adc; '>:</span>
    delay <span style='color:#808030; '>=</span> <span style='color:#603000; '>atoi</span><span style='color:#808030; '>(</span>optarg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
   <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'m'</span><span style='color:#e34adc; '>:</span>
    <span style='color:#603000; '>sprintf</span><span style='color:#808030; '>(</span>msg<span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%s</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> optarg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
   <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'h'</span><span style='color:#e34adc; '>:</span>
    usage<span style='color:#808030; '>(</span>argv<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
<span style='color:#e34adc; '>&#xa0;&#xa0;&#xa0;</span><span style='color:#800000; font-weight:bold; '>default</span><span style='color:#e34adc; '>:</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Invalid parameters. Use </span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '> -h for help.</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span>argv<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    usage<span style='color:#808030; '>(</span>argv<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
   <span style='color:#800080; '>}</span>

 <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>source port </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>, target port </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>, delay between packets </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> ms</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span>source_port<span style='color:#808030; '>,</span>target_port<span style='color:#808030; '>,</span>delay<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 <span style='color:#696969; '>/* Prepare sockets */</span>
 assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>udp_sock<span style='color:#808030; '>=</span><span style='color:#400000; '>socket</span><span style='color:#808030; '>(</span>PF_INET<span style='color:#808030; '>,</span>SOCK_RAW<span style='color:#808030; '>,</span>IPPROTO_RAW<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 assert<span style='color:#808030; '>(</span><span style='color:#400000; '>setsockopt</span><span style='color:#808030; '>(</span>udp_sock<span style='color:#808030; '>,</span>IPPROTO_IP<span style='color:#808030; '>,</span>IP_HDRINCL<span style='color:#808030; '>,</span><span style='color:#808030; '>&amp;</span>one<span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>one<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>=</span><span style='color:#400000; '>socket</span><span style='color:#808030; '>(</span>AF_INET<span style='color:#808030; '>,</span> SOCK_RAW<span style='color:#808030; '>,</span> IPPROTO_ICMP<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#696969; '>/* discard root privileges */</span>
 assert<span style='color:#808030; '>(</span>setuid<span style='color:#808030; '>(</span>getuid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 assert<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#696969; '>/* Set signal handler for SIGIO */</span>
 handler<span style='color:#808030; '>.</span>sa_handler <span style='color:#808030; '>=</span> <span style='color:#400000; '>Handler</span><span style='color:#800080; '>;</span>
 <span style='color:#696969; '>/* Create mask that mask no signal */</span>
 assert<span style='color:#808030; '>(</span>sigemptyset<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>handler<span style='color:#808030; '>.</span>sa_mask<span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#696969; '>/* No flags */</span>
 handler<span style='color:#808030; '>.</span>sa_flags <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 assert<span style='color:#808030; '>(</span>sigaction<span style='color:#808030; '>(</span>SIGIO<span style='color:#808030; '>,</span><span style='color:#808030; '>&amp;</span>handler<span style='color:#808030; '>,</span><span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#696969; '>/* We must own the socket to receive the SIGIO message */</span>
 assert<span style='color:#808030; '>(</span>fcntl<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>,</span>F_SETOWN<span style='color:#808030; '>,</span>getpid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#696969; '>/* Arrange for nonblocking I/O and SIGIO delivery */</span>
 assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>flags <span style='color:#808030; '>=</span> fcntl<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>,</span> F_GETFL<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 assert<span style='color:#808030; '>(</span>fcntl<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>,</span>F_SETFL<span style='color:#808030; '>,</span><span style='color:#808030; '>(</span>flags<span style='color:#808030; '>|</span>O_NONBLOCK<span style='color:#808030; '>)</span><span style='color:#808030; '>|</span>FASYNC<span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 <span style='color:#696969; '>/* for PlanetLab: bind source port */</span>
 <span style='color:#800000; font-weight:bold; '>struct</span> sockaddr_in <span style='color:#603000; '>sin</span><span style='color:#800080; '>;</span>
 assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>foo_sock <span style='color:#808030; '>=</span> <span style='color:#400000; '>socket</span><span style='color:#808030; '>(</span>AF_INET<span style='color:#808030; '>,</span> SOCK_DGRAM<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 bzero<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span> <span style='color:#603000; '>sin</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#603000; '>sin</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#603000; '>sin</span><span style='color:#808030; '>.</span>sin_family <span style='color:#808030; '>=</span> AF_INET<span style='color:#800080; '>;</span>
 <span style='color:#603000; '>sin</span><span style='color:#808030; '>.</span>sin_port <span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span>source_port<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 assert<span style='color:#808030; '>(</span><span style='color:#400000; '>bind</span><span style='color:#808030; '>(</span>foo_sock<span style='color:#808030; '>,</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> <span style='color:#400000; '>sockaddr</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span><span style='color:#603000; '>sin</span><span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#603000; '>sin</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

 <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span><span style='color:#603000; '>feof</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stdin</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
  <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>!</span><span style='color:#603000; '>feof</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stdin</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span><span style='color:#603000; '>fgets</span><span style='color:#808030; '>(</span>line<span style='color:#808030; '>,</span>STR_SIZE<span style='color:#808030; '>,</span><span style='color:#603000; '>stdin</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span>line<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>packet_to_read<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
    packet_to_read <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    n_ok <span style='color:#808030; '>+</span><span style='color:#808030; '>=</span> get_packets<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
   <span style='color:#800080; '>}</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#603000; '>feof</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stdin</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
   <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>

  <span style='color:#696969; '>/* get target address */</span>
  assert<span style='color:#808030; '>(</span><span style='color:#603000; '>sscanf</span><span style='color:#808030; '>(</span>line<span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span><span style='color:#808030; '>&amp;</span><span style='color:#808030; '>(</span>ipint<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#808030; '>&amp;</span><span style='color:#808030; '>(</span>ipint<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#808030; '>&amp;</span><span style='color:#808030; '>(</span>ipint<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#808030; '>&amp;</span><span style='color:#808030; '>(</span>ipint<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>i<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>i<span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>4</span><span style='color:#800080; '>;</span>i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span>
   ip<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>byte<span style='color:#808030; '>)</span>ipint<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
  n_try<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
  lgr<span style='color:#808030; '>=</span><span style='color:#603000; '>snprintf</span><span style='color:#808030; '>(</span>target<span style='color:#808030; '>,</span>STR_SIZE<span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>lgr<span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>lgr<span style='color:#808030; '>&lt;</span>STR_SIZE<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span>
   <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>UDP ping to </span><span style='color:#0f69ff; '>%s</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span>target<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

  <span style='color:#696969; '>/* send UDP packet and get answers */</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>is_valid<span style='color:#808030; '>(</span>ip<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
   <span style='color:#696969; '>/* try sending until success, and manage answers */</span>
   <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span>send_udp_ping<span style='color:#808030; '>(</span>udp_sock<span style='color:#808030; '>,</span>target<span style='color:#808030; '>)</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>packet_to_read<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
     packet_to_read <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
     n_ok <span style='color:#808030; '>+</span><span style='color:#808030; '>=</span> get_packets<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
     <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
   n_sent<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
   <span style='color:#696969; '>/* wait before sending next packet, but manage arrivals */</span>
   req<span style='color:#808030; '>.</span>tv_sec <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span><span style='color:#808030; '>)</span>delay<span style='color:#808030; '>/</span><span style='color:#008c00; '>1000000</span><span style='color:#800080; '>;</span>
   req<span style='color:#808030; '>.</span>tv_nsec <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>delay<span style='color:#808030; '>%</span><span style='color:#008c00; '>1000000</span><span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>1000</span><span style='color:#800080; '>;</span>
   <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span>nanosleep<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>req<span style='color:#808030; '>,</span><span style='color:#808030; '>&amp;</span>rem<span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
    <span style='color:#696969; '>/* check if there are packets to read */</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>packet_to_read<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
     packet_to_read <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
     n_ok <span style='color:#808030; '>+</span><span style='color:#808030; '>=</span> get_packets<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
     <span style='color:#800080; '>}</span>
    req<span style='color:#808030; '>.</span>tv_sec <span style='color:#808030; '>=</span> rem<span style='color:#808030; '>.</span>tv_sec<span style='color:#800080; '>;</span>
    req<span style='color:#808030; '>.</span>tv_nsec <span style='color:#808030; '>=</span> rem<span style='color:#808030; '>.</span>tv_nsec<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>packet_to_read<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
    packet_to_read <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    n_ok <span style='color:#808030; '>+</span><span style='color:#808030; '>=</span> get_packets<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
   <span style='color:#800080; '>}</span>
  <span style='color:#800000; font-weight:bold; '>else</span>
   <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Invalid address: </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

  <span style='color:#696969; '>/* print status */</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>n_sent<span style='color:#808030; '>%</span><span style='color:#008c00; '>10000</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%ld</span><span style='color:#0000e6; '> UDP ping launched until now (</span><span style='color:#0f69ff; '>%ld</span><span style='color:#0000e6; '> valid answers, </span><span style='color:#0f69ff; '>%ld</span><span style='color:#0000e6; '> random IP sampled).</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span>n_sent<span style='color:#808030; '>,</span>n_ok<span style='color:#808030; '>,</span>n_try<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
   <span style='color:#800080; '>}</span>
  <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>.</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fflush</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

  <span style='color:#800080; '>}</span> <span style='color:#696969; '>/* end of main loop */</span>

 <span style='color:#696969; '>/* wait for last packets and manage them */</span>
 <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>END OF SENDING LOOP</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fflush</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>
 req<span style='color:#808030; '>.</span>tv_sec <span style='color:#808030; '>=</span> FINAL_DELAY<span style='color:#800080; '>;</span>
 req<span style='color:#808030; '>.</span>tv_nsec <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span>nanosleep<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>req<span style='color:#808030; '>,</span><span style='color:#808030; '>&amp;</span>rem<span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>packet_to_read<span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
   packet_to_read <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
   n_ok <span style='color:#808030; '>+</span><span style='color:#808030; '>=</span> get_packets<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
   <span style='color:#800080; '>}</span>
  req<span style='color:#808030; '>.</span>tv_sec <span style='color:#808030; '>=</span> rem<span style='color:#808030; '>.</span>tv_sec<span style='color:#800080; '>;</span>
  req<span style='color:#808030; '>.</span>tv_nsec <span style='color:#808030; '>=</span> rem<span style='color:#808030; '>.</span>tv_nsec<span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>

 close<span style='color:#808030; '>(</span>udp_sock<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 close<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 <span style='color:#800080; '>}</span>