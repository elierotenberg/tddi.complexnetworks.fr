<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>stdio.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>stdlib.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>string.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>unistd.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>errno.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>sys/types.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>time.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>math.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>assert.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>signal.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>fcntl.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>arpa/inet.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>sys/types.h</span><span style='color:#800000; '>></span>

<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> __FAVOR_BSD 1</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>netinet/ip.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>netinet/ip_icmp.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>netinet/udp.h</span><span style='color:#800000; '>></span>

<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> PACKET_SIZE 1024</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> MESSAGE_SIZE 1024</span>


<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>int</span> uint32<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>short</span> uint16<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>char</span> uint8<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>char</span> byte<span style='color:#800080; '>;</span>

<span style='color:#800000; font-weight:bold; '>int</span> verbose<span style='color:#800080; '>;</span> <span style='color:#696969; '>// = 1 if verbose mode is on, = 0 else</span>

<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>struct</span> <span style='color:#800080; '>{</span>             <span style='color:#696969; '>// probe_desc</span>
  <span style='color:#800000; font-weight:bold; '>int</span> udp_sock<span style='color:#800080; '>;</span>              <span style='color:#696969; '>// UDP socket, used to send the UDP probe</span>
  <span style='color:#800000; font-weight:bold; '>int</span> icmp_sock<span style='color:#800080; '>;</span>             <span style='color:#696969; '>// ICMP socket, used to receive the ICMP response</span>
  <span style='color:#800000; font-weight:bold; '>int</span> port<span style='color:#800080; '>;</span>                  <span style='color:#696969; '>// UDP destination port</span>
  uint8_t ttl<span style='color:#800080; '>;</span>               <span style='color:#696969; '>// IP TTL</span>
  <span style='color:#800000; font-weight:bold; '>char</span> msg<span style='color:#808030; '>[</span>MESSAGE_SIZE<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>    <span style='color:#696969; '>// UDP message</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> timespec timeout_t<span style='color:#800080; '>;</span> <span style='color:#696969; '>// Probe timeout in struct timespec format (delay after which a probe is considered lost)</span>
<span style='color:#800080; '>}</span> probe_desc<span style='color:#800080; '>;</span>                <span style='color:#696969; '>// UDP probe descriptor typedef</span>

<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>enum</span> <span style='color:#800080; '>{</span>
  TTL_EXPIRED<span style='color:#808030; '>,</span>          <span style='color:#696969; '>// IP packet TTL expired. r_addr: ip (interface) used by the host to send the ICMP TIME EXCEEDED message</span>
  TIMEOUT<span style='color:#808030; '>,</span>              <span style='color:#696969; '>// No response has been received before the specified timeout has expired. r_addr: "*"</span>
<span style='color:#800080; '>}</span> response_type<span style='color:#800080; '>;</span>

<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>struct</span> <span style='color:#800080; '>{</span>
  response_type r_type<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>char</span> r_addr<span style='color:#808030; '>[</span>INET_ADDRSTRLEN<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// if r_type == TTL_EXPIRED, contains the numbers-and-dots of the IPv4 interface that sent the TTL expired message. else, contains "*".</span>
<span style='color:#800080; '>}</span> probe_response<span style='color:#800080; '>;</span>

<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> NO_ICMP_PACKET_TO_READ 0</span>
<span style='color:#800000; font-weight:bold; '>int</span> icmp_packet_to_read <span style='color:#808030; '>=</span> NO_ICMP_PACKET_TO_READ<span style='color:#800080; '>;</span> <span style='color:#696969; '>// Global variable used by the handler to check whether there are ICMP packets to read.</span>


<span style='color:#800000; font-weight:bold; '>int</span> send_udp_probe<span style='color:#808030; '>(</span>probe_desc<span style='color:#808030; '>*</span> p_probe_desc<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>*</span> target<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Send an UDP probe as described towards the target</span>
  <span style='color:#800000; font-weight:bold; '>int</span> udp_sock <span style='color:#808030; '>=</span> p_probe_desc<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>udp_sock<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> port <span style='color:#808030; '>=</span> p_probe_desc<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>port<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> ttl <span style='color:#808030; '>=</span> p_probe_desc<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ttl<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>*</span> msg <span style='color:#808030; '>=</span> p_probe_desc<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>msg<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> sockaddr_in target_addr<span style='color:#800080; '>;</span>                                <span style='color:#696969; '>// Target adress representation</span>
  <span style='color:#800000; font-weight:bold; '>char</span> packet<span style='color:#808030; '>[</span>PACKET_SIZE<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>                                      <span style='color:#696969; '>// Packet buffer allocation</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> ip <span style='color:#808030; '>*</span>iph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>packet<span style='color:#800080; '>;</span>                           <span style='color:#696969; '>// IP header allocation</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> udphdr <span style='color:#808030; '>*</span>udph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> udphdr <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span>packet <span style='color:#808030; '>+</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// UDP header allocation</span>
  <span style='color:#603000; '>memset</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span>target_addr<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>target_addr<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>           <span style='color:#696969; '>// Initialize all bits of target_addr to 0</span>
  <span style='color:#603000; '>memset</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>packet<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> PACKET_SIZE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>                         <span style='color:#696969; '>// Initialize all bits of packet to 0</span>

  target_addr<span style='color:#808030; '>.</span>sin_family <span style='color:#808030; '>=</span> AF_INET<span style='color:#800080; '>;</span>                              <span style='color:#696969; '>// Target address family: Internet</span>
  target_addr<span style='color:#808030; '>.</span>sin_port <span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span>port<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>                            <span style='color:#696969; '>// Target port (passed argument) reformatted in big-endian binary format</span>

  assert<span style='color:#808030; '>(</span>inet_aton<span style='color:#808030; '>(</span>target<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>target_addr<span style='color:#808030; '>.</span>sin_addr<span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>                                       <span style='color:#696969; '>// converts the dots-and-number string target to a sin_addr and stores the result in target_addr.sin_addr</span>
  assert<span style='color:#808030; '>(</span><span style='color:#400000; '>connect</span><span style='color:#808030; '>(</span>udp_sock<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> <span style='color:#400000; '>sockaddr</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span>target_addr<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> sockaddr_in<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// connects the socket (passed argument) to the target</span>

  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_hl  <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span> <span style='color:#808030; '>></span><span style='color:#808030; '>></span> <span style='color:#008c00; '>2</span><span style='color:#800080; '>;</span>                                        <span style='color:#696969; '>// IP header length: 5 bytes (default)</span>
  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_v   <span style='color:#808030; '>=</span> <span style='color:#008000; '>0x4</span><span style='color:#800080; '>;</span>                                                           <span style='color:#696969; '>// IP version: 4 (IPv4)</span>
  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_len <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> udphdr<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#603000; '>strlen</span><span style='color:#808030; '>(</span>msg<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>   <span style='color:#696969; '>// IP packet total length (IP datagram + UDP header + message)</span>
  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_tos <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>                                                             <span style='color:#696969; '>// IP Type Of Service: 0 (default)</span>
  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_ttl <span style='color:#808030; '>=</span> ttl<span style='color:#800080; '>;</span>                                                           <span style='color:#696969; '>// IP TTL: ttl (passed argument)</span>
  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_off <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>                                                             <span style='color:#696969; '>// IP fragment offset: 0 (monofragment datagram)</span>
  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_p   <span style='color:#808030; '>=</span> IPPROTO_UDP<span style='color:#800080; '>;</span>                                                   <span style='color:#696969; '>// IP transport layer protocol: UDP (17)</span>
  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_sum <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>                                                             <span style='color:#696969; '>// IP checksum: 0. Will be accurately set upon sending.</span>
  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_src<span style='color:#808030; '>.</span>s_addr <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>                                                      <span style='color:#696969; '>// IP source address: 0. (Not to be used)</span>
  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_dst<span style='color:#808030; '>.</span>s_addr <span style='color:#808030; '>=</span> target_addr<span style='color:#808030; '>.</span>sin_addr<span style='color:#808030; '>.</span>s_addr<span style='color:#800080; '>;</span>                            <span style='color:#696969; '>// IP target address: target (passed argument), previously properly formatted</span>


 <span style='color:#696969; '>/* store information to recognise answer packets */</span>
  iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_id <span style='color:#808030; '>=</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>(</span>uint16 <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span><span style='color:#808030; '>(</span>iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_dst<span style='color:#808030; '>.</span>s_addr<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>                             <span style='color:#696969; '>// Stores the first 2 bytes of the target destination in the IP ID field, for subsequent recognition</span>
  udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_sport <span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span>port<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_dport <span style='color:#808030; '>=</span> target_addr<span style='color:#808030; '>.</span>sin_port<span style='color:#800080; '>;</span>                                       <span style='color:#696969; '>// UDP destination port: port (global variable)</span>
  udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_ulen <span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> udphdr<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#808030; '>(</span><span style='color:#603000; '>strlen</span><span style='color:#808030; '>(</span>msg<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// UDP length (NS form)</span>
  udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_sum <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>                                                            <span style='color:#696969; '>// UDP checksum: 0. (Not to be used)</span>

  <span style='color:#603000; '>strcpy</span><span style='color:#808030; '>(</span>packet<span style='color:#808030; '>+</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> udphdr<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// Copies the message msg (global variable) into the correct location within the packet (packet starting address + ip header offset + udp header offset)</span>

  <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#808030; '>(</span>write<span style='color:#808030; '>(</span>udp_sock<span style='color:#808030; '>,</span>packet<span style='color:#808030; '>,</span>iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_len<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// Finally tries to send the complete packet on the socket (passed argument)</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>void</span> handler_trigger<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> signalType<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Signal handler that set icmp_packet_to_read to SIGIO whenever there is an icmp packet to read</span>
  icmp_packet_to_read <span style='color:#808030; '>=</span> signalType<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>int</span> inspect_icmp_packet<span style='color:#808030; '>(</span>probe_desc<span style='color:#808030; '>*</span> p_probe_desc<span style='color:#808030; '>,</span> probe_response<span style='color:#808030; '>*</span> p_probe_response<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
  <span style='color:#800000; font-weight:bold; '>int</span> icmp_sock <span style='color:#808030; '>=</span> p_probe_desc<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>icmp_sock<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> sockaddr_in r_addr<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> ip <span style='color:#808030; '>*</span>r_iph<span style='color:#808030; '>,</span> <span style='color:#808030; '>*</span>s_iph<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> icmphdr <span style='color:#808030; '>*</span>r_icmph<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> udphdr <span style='color:#808030; '>*</span>s_udph<span style='color:#800080; '>;</span>
  socklen_t len<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> type<span style='color:#800080; '>;</span>
  <span style='color:#696969; '>// int code;</span>
  ssize_t r_size<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>char</span> packet<span style='color:#808030; '>[</span>PACKET_SIZE<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Inspecting ICMP Packet.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>
  len <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>socklen_t<span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>r_addr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  r_size <span style='color:#808030; '>=</span> <span style='color:#400000; '>recvfrom</span><span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>packet<span style='color:#808030; '>,</span> PACKET_SIZE<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> <span style='color:#400000; '>sockaddr</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span>r_addr<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>len<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>  <span style='color:#696969; '>// Attemps to read on the icmp socket buffer</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>r_size <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Actually no packet to read, false alert.</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>r_size <span style='color:#808030; '>&lt;</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> icmphdr<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip<span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Packet is to small.</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>
  r_iph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>packet<span style='color:#800080; '>;</span> <span style='color:#696969; '>// IP header of the received packet</span>
  assert<span style='color:#808030; '>(</span>r_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_p <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> IPPROTO_ICMP<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// Checks that the packet is actually an ICMP packet</span>
  r_icmph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> icmphdr <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>r_iph<span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>r_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_hl<span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// ICMP header of the received packet</span>
  type <span style='color:#808030; '>=</span> r_icmph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>type<span style='color:#800080; '>;</span> <span style='color:#696969; '>// Type of the ICMP message</span>
  <span style='color:#696969; '>//  code = r_icmph->code; // Code of the ICMP message</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>type <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> ICMP_TIME_EXCEEDED<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Message type is not ICMP_TIME_EXCEEDED, and is therefore irrelevant.</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>
  s_iph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> ip <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>r_icmph<span style='color:#808030; '>+</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> icmphdr<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// Original IP header attached to the ICMP error message</span>
  s_udph <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> udphdr <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>s_iph<span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>s_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_hl<span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    <span style='color:#696969; '>// Original UDP header attached to the ICMP error message</span>
  <span style='color:#696969; '>//    if (verbose) fprintf(stderr," from %s",inet_ntoa(r_iph->ip_src));</span>
  <span style='color:#696969; '>//    if (verbose) fprintf(stderr,", initially %s. ",inet_ntoa(s_iph->ip_dst));</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span> s_udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_dport <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span>p_probe_desc<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>port<span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Original UDP destination port doesn't match</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span> s_udph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>uh_sport <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span>p_probe_desc<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>port<span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Inconsistent packet (UDP source port first check)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>
  <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>(</span>uint16 <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span><span style='color:#808030; '>(</span>s_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_dst<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> s_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_id <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Inconsistent packet (IP id second check)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>
  <span style='color:#696969; '>// At this point, the packet is indeed a TTL-expired message sent by a host encounter along the way towards the target.</span>
  p_probe_response<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>r_type <span style='color:#808030; '>=</span> TTL_EXPIRED<span style='color:#800080; '>;</span>
  <span style='color:#603000; '>sprintf</span><span style='color:#808030; '>(</span>p_probe_response<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>r_addr<span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%s</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> <span style='color:#400000; '>inet_ntoa</span><span style='color:#808030; '>(</span>r_iph<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>ip_src<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>void</span> recv_udp_response<span style='color:#808030; '>(</span>probe_desc<span style='color:#808030; '>*</span> p_probe_desc<span style='color:#808030; '>,</span> probe_response<span style='color:#808030; '>*</span> p_probe_resp<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> timespec req<span style='color:#808030; '>,</span> rem<span style='color:#800080; '>;</span>
  req<span style='color:#808030; '>.</span>tv_sec <span style='color:#808030; '>=</span> p_probe_desc<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>timeout_t<span style='color:#808030; '>.</span>tv_sec<span style='color:#800080; '>;</span>
  req<span style='color:#808030; '>.</span>tv_nsec <span style='color:#808030; '>=</span> p_probe_desc<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>timeout_t<span style='color:#808030; '>.</span>tv_nsec<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>while</span><span style='color:#808030; '>(</span>icmp_packet_to_read <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> NO_ICMP_PACKET_TO_READ<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Signal interruption (</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>).</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> icmp_packet_to_read<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>icmp_packet_to_read <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> SIGIO<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      icmp_packet_to_read <span style='color:#808030; '>=</span> NO_ICMP_PACKET_TO_READ<span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>inspect_icmp_packet<span style='color:#808030; '>(</span>p_probe_desc<span style='color:#808030; '>,</span> p_probe_resp<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
      icmp_packet_to_read <span style='color:#808030; '>=</span> NO_ICMP_PACKET_TO_READ<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
  <span style='color:#800080; '>}</span>
  <span style='color:#800000; font-weight:bold; '>while</span><span style='color:#808030; '>(</span>nanosleep<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>req<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>rem<span style='color:#808030; '>)</span> <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Reads any incoming ICMP packets in search for a proper response until timeout expires</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Nanosleep interrupted. (SIGIO=</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>, icmp_packet_to_read=</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>)</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> SIGIO<span style='color:#808030; '>,</span> icmp_packet_to_read<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>while</span><span style='color:#808030; '>(</span>icmp_packet_to_read <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> NO_ICMP_PACKET_TO_READ<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Signal interruption (</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>).</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> icmp_packet_to_read<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>icmp_packet_to_read <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> SIGIO<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    icmp_packet_to_read <span style='color:#808030; '>=</span> NO_ICMP_PACKET_TO_READ<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>inspect_icmp_packet<span style='color:#808030; '>(</span>p_probe_desc<span style='color:#808030; '>,</span> p_probe_resp<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#800000; font-weight:bold; '>do</span> <span style='color:#800080; '>{</span>
        req<span style='color:#808030; '>.</span>tv_sec <span style='color:#808030; '>=</span> rem<span style='color:#808030; '>.</span>tv_sec<span style='color:#800080; '>;</span>
        req<span style='color:#808030; '>.</span>tv_nsec <span style='color:#808030; '>=</span> rem<span style='color:#808030; '>.</span>tv_nsec<span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>while</span><span style='color:#808030; '>(</span>nanosleep<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>req<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>rem<span style='color:#808030; '>)</span> <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
      <span style='color:#800080; '>}</span>
      <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
    icmp_packet_to_read <span style='color:#808030; '>=</span> NO_ICMP_PACKET_TO_READ<span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    req<span style='color:#808030; '>.</span>tv_sec <span style='color:#808030; '>=</span> rem<span style='color:#808030; '>.</span>tv_sec<span style='color:#800080; '>;</span>
    req<span style='color:#808030; '>.</span>tv_nsec <span style='color:#808030; '>=</span> rem<span style='color:#808030; '>.</span>tv_nsec<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Returning to nanosleep (sec = </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>, nsec = </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>)</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span><span style='color:#808030; '>)</span>req<span style='color:#808030; '>.</span>tv_sec<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span><span style='color:#808030; '>)</span>req<span style='color:#808030; '>.</span>tv_nsec<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
  <span style='color:#800080; '>}</span>
  p_probe_resp<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>r_type <span style='color:#808030; '>=</span> TIMEOUT<span style='color:#800080; '>;</span>
  <span style='color:#603000; '>sprintf</span><span style='color:#808030; '>(</span>p_probe_resp<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>r_addr<span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>*</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>inline</span> <span style='color:#800000; font-weight:bold; '>int</span> is_valid<span style='color:#808030; '>(</span>byte<span style='color:#808030; '>*</span> ip<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Checks whether an IP is valid for probing. Includes blacklisting.</span>

  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>14</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>39</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>127</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>128</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>169</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>254</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>172</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>31</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>191</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>192</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>192</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>192</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>88</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>99</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>192</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>168</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>192</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>18</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>19</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>223</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>224</span><span style='color:#808030; '>)</span>
    <span style='color:#696969; '>/* Corresponds to multicast (former class D networks), */</span>
    <span style='color:#696969; '>/* first octet between 224 and 239, */</span>
    <span style='color:#696969; '>/* and reserved (former class E networks), */</span>
    <span style='color:#696969; '>/* first octet between 240 and 255 */</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>

  <span style='color:#696969; '>// PlanetLab blacklist below </span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>63</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>215</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>104</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>107</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>67</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>210</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>80</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>95</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>74</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>202</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>16</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>19</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>207</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>174</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>77</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>207</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>174</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>98</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>207</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>174</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>114</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>207</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>174</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>173</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>207</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>174</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>210</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>207</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>174</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>211</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>63</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>214</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>32</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>39</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>63</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>215</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>108</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>111</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>64</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>74</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>187</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>199</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>45</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>166</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>240</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>

  <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>inline</span> <span style='color:#800000; font-weight:bold; '>void</span> usage<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>*</span> cmd<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '> sends a UDP probes towards random valid IP addresses with increasing TTL (starting from 0), until more than one host sends back an ICMP Time Exceeded message, and displays the observed interfaces for each TTL.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> cmd<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Output format: &lt;TTL> &lt;i> &lt;Addres of i-th target> &lt;Response for i-th target (</span><span style='color:#0f69ff; '>\"</span><span style='color:#0000e6; '>*</span><span style='color:#0f69ff; '>\"</span><span style='color:#0000e6; '> if no response)></span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Usage:</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '> </span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '> [-p port] [-n number] [-d delay] [-t timeout] [-m message] [-T max_ttl] [-v] [-h]</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> cmd<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>   -p port: UDP Destination port. Default: Random port in the 49152-65535 range.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>   -n number: Number of probes sent for each TTL. Default: 100.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>   -d delay: Delay (in milliseconds) between the sending of two successive probes. Default: 1000.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>   -t timeout: Timeout (in milliseconds) before a probe is declared lost. Default: 1000.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>   -m message: Content of the UDP message Default: admin@localhost.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>   -T max_ttl: Stop after at most TTL, regardless of whether more than one host sent back an ICMP Time Exceeded message. Default: 30.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>   -v: Verbose mode. (Default: not verbose)</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>   -h: Displays this help.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>inline</span> <span style='color:#800000; font-weight:bold; '>void</span> ms_to_timespec<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> timeout_ms<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>struct</span> timespec<span style='color:#808030; '>*</span> p_timeout_t<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Converts the given timeout in millisec into the corresponding timespec</span>
  p_timeout_t<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>tv_sec <span style='color:#808030; '>=</span> timeout_ms<span style='color:#808030; '>/</span><span style='color:#008c00; '>1000</span><span style='color:#800080; '>;</span>                 <span style='color:#696969; '>// seconds = milliseconds / 1000</span>
  p_timeout_t<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>tv_nsec <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>timeout_ms <span style='color:#808030; '>%</span> <span style='color:#008c00; '>1000</span><span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>1000000</span><span style='color:#800080; '>;</span>    <span style='color:#696969; '>// nanoseconds = (milliseconds % 1000) * 1000000</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>inline</span> <span style='color:#800000; font-weight:bold; '>void</span> pickTarget<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>*</span> target<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
  byte ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> k<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>do</span> <span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>k <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> k <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>4</span><span style='color:#800080; '>;</span> k<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span>
      ip<span style='color:#808030; '>[</span>k<span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#603000; '>rand</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>%</span> <span style='color:#008c00; '>256</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>while</span><span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>is_valid<span style='color:#808030; '>(</span>ip<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>sprintf</span><span style='color:#808030; '>(</span>target<span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>%d</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> ip<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>int</span> <span style='color:#400000; '>main</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> argc<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>argv<span style='color:#808030; '>[</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
  <span style='color:#800000; font-weight:bold; '>int</span> port<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> number<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> delay_ms<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> timeout_ms<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>char</span> msg<span style='color:#808030; '>[</span>MESSAGE_SIZE<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> max_ttl<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>char</span> c<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> udp_sock<span style='color:#808030; '>,</span> icmp_sock<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>struct</span> sigaction sig_handler<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> flags<span style='color:#800080; '>;</span>
  icmp_packet_to_read <span style='color:#808030; '>=</span> NO_ICMP_PACKET_TO_READ<span style='color:#800080; '>;</span>

  assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>uint8<span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>uint16<span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>uint32<span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

  <span style='color:#603000; '>srand</span><span style='color:#808030; '>(</span>getpid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

  <span style='color:#696969; '>// Inits the parameters with default values</span>

  port <span style='color:#808030; '>=</span> <span style='color:#008c00; '>49152</span> <span style='color:#808030; '>+</span> random<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>%</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>65535</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>49152</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  number <span style='color:#808030; '>=</span> <span style='color:#008c00; '>100</span><span style='color:#800080; '>;</span>
  timeout_ms <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1000</span><span style='color:#800080; '>;</span>
  delay_ms <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1000</span><span style='color:#800080; '>;</span>
  verbose <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>sprintf</span><span style='color:#808030; '>(</span>msg<span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>admin@localhost</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  max_ttl <span style='color:#808030; '>=</span> <span style='color:#008c00; '>30</span><span style='color:#800080; '>;</span>

  <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>=</span>getopt<span style='color:#808030; '>(</span>argc<span style='color:#808030; '>,</span>argv<span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>hvp:n:d:t:m:T:</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span>
    <span style='color:#800000; font-weight:bold; '>switch</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'p'</span><span style='color:#e34adc; '>:</span>
      port <span style='color:#808030; '>=</span> <span style='color:#603000; '>atoi</span><span style='color:#808030; '>(</span>optarg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'n'</span><span style='color:#e34adc; '>:</span>
      number <span style='color:#808030; '>=</span> <span style='color:#603000; '>atoi</span><span style='color:#808030; '>(</span>optarg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'d'</span><span style='color:#e34adc; '>:</span>
      delay_ms <span style='color:#808030; '>=</span> <span style='color:#603000; '>atoi</span><span style='color:#808030; '>(</span>optarg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'t'</span><span style='color:#e34adc; '>:</span>
      timeout_ms <span style='color:#808030; '>=</span> <span style='color:#603000; '>atoi</span><span style='color:#808030; '>(</span>optarg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'m'</span><span style='color:#7d0045; '> </span><span style='color:#e34adc; '>:</span>
      <span style='color:#603000; '>sprintf</span><span style='color:#808030; '>(</span>msg<span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%s</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> optarg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'T'</span><span style='color:#7d0045; '> </span><span style='color:#e34adc; '>:</span>
      max_ttl <span style='color:#808030; '>=</span> <span style='color:#603000; '>atoi</span><span style='color:#808030; '>(</span>optarg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'v'</span><span style='color:#e34adc; '>:</span>
      verbose <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#0000e6; '>'h'</span><span style='color:#e34adc; '>:</span>
      usage<span style='color:#808030; '>(</span>argv<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#603000; '>exit</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
<span style='color:#e34adc; '>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#800000; font-weight:bold; '>default</span><span style='color:#e34adc; '>:</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Invalid parameters.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      usage<span style='color:#808030; '>(</span>argv<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#603000; '>exit</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>

  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Port: </span><span style='color:#0f69ff; '>%d</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> port<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Number of probes per TTL: </span><span style='color:#0f69ff; '>%d</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> number<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Maximum TTL: </span><span style='color:#0f69ff; '>%d</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> max_ttl<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Delay between probes: </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> ms</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> delay_ms<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Probe timeout: </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> ms</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> timeout_ms<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Content of the UDP message: </span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '> (message size: </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>)</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> msg<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span><span style='color:#808030; '>)</span><span style='color:#603000; '>strlen</span><span style='color:#808030; '>(</span>msg<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>


  <span style='color:#800000; font-weight:bold; '>int</span> one <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
  assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>udp_sock<span style='color:#808030; '>=</span><span style='color:#400000; '>socket</span><span style='color:#808030; '>(</span>PF_INET<span style='color:#808030; '>,</span>SOCK_RAW<span style='color:#808030; '>,</span>IPPROTO_RAW<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>             <span style='color:#696969; '>// Prepares the udp socket</span>
  assert<span style='color:#808030; '>(</span><span style='color:#400000; '>setsockopt</span><span style='color:#808030; '>(</span>udp_sock<span style='color:#808030; '>,</span>IPPROTO_IP<span style='color:#808030; '>,</span>IP_HDRINCL<span style='color:#808030; '>,</span><span style='color:#808030; '>&amp;</span>one<span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>one<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>=</span><span style='color:#400000; '>socket</span><span style='color:#808030; '>(</span>AF_INET<span style='color:#808030; '>,</span> SOCK_RAW<span style='color:#808030; '>,</span> IPPROTO_ICMP<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>         <span style='color:#696969; '>// Prepares the icmp socket</span>


  assert<span style='color:#808030; '>(</span>setuid<span style='color:#808030; '>(</span>getuid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>   <span style='color:#696969; '>// Checks for root privileges</span>
  assert<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

  sig_handler<span style='color:#808030; '>.</span>sa_handler <span style='color:#808030; '>=</span> handler_trigger<span style='color:#800080; '>;</span> <span style='color:#696969; '>// Sets the signal handler for SIGIO</span>
  assert<span style='color:#808030; '>(</span>sigemptyset<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>sig_handler<span style='color:#808030; '>.</span>sa_mask<span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// Creates a mask that mask no signal</span>

  sig_handler<span style='color:#808030; '>.</span>sa_flags <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// No flags</span>
  assert<span style='color:#808030; '>(</span>sigaction<span style='color:#808030; '>(</span>SIGIO<span style='color:#808030; '>,</span><span style='color:#808030; '>&amp;</span>sig_handler<span style='color:#808030; '>,</span><span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

  assert<span style='color:#808030; '>(</span>fcntl<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>,</span>F_SETOWN<span style='color:#808030; '>,</span>getpid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// Own the socket to receive the SIGIO message</span>

  <span style='color:#696969; '>/* Arrange for nonblocking I/O and SIGIO delivery */</span>
  assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>flags <span style='color:#808030; '>=</span> fcntl<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>,</span> F_GETFL<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  assert<span style='color:#808030; '>(</span>fcntl<span style='color:#808030; '>(</span>icmp_sock<span style='color:#808030; '>,</span>F_SETFL<span style='color:#808030; '>,</span><span style='color:#808030; '>(</span>flags<span style='color:#808030; '>|</span>O_NONBLOCK<span style='color:#808030; '>)</span><span style='color:#808030; '>|</span>FASYNC<span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#696969; '>// assert((flags = fcntl(udp_sock, F_GETFL, 0))>=0);</span>
  <span style='color:#696969; '>// assert(fcntl(udp_sock,F_SETFL,(flags|O_NONBLOCK)|FASYNC)>=0);</span>

  <span style='color:#696969; '>// PlanetLab-specific trick to ensure proper ICMP response forwarding.</span>

  <span style='color:#800000; font-weight:bold; '>struct</span> sockaddr_in <span style='color:#603000; '>sin</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> dummy_sock<span style='color:#800080; '>;</span>
  assert<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>dummy_sock<span style='color:#808030; '>=</span><span style='color:#400000; '>socket</span><span style='color:#808030; '>(</span>AF_INET<span style='color:#808030; '>,</span> SOCK_DGRAM<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// Prepares the dummy socket</span>

  bzero<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span><span style='color:#603000; '>sin</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#603000; '>sin</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#603000; '>sin</span><span style='color:#808030; '>.</span>sin_family <span style='color:#808030; '>=</span> AF_INET<span style='color:#800080; '>;</span>
  <span style='color:#603000; '>sin</span><span style='color:#808030; '>.</span>sin_port <span style='color:#808030; '>=</span> <span style='color:#400000; '>htons</span><span style='color:#808030; '>(</span>port<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  assert<span style='color:#808030; '>(</span><span style='color:#400000; '>bind</span><span style='color:#808030; '>(</span>dummy_sock<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>struct</span> <span style='color:#400000; '>sockaddr</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span> <span style='color:#603000; '>sin</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#603000; '>sin</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

  <span style='color:#696969; '>// End of the PlanetLab-specific trick.</span>


  <span style='color:#800000; font-weight:bold; '>int</span> current_ttl <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>int</span> number_of_responses <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#808030; '>*</span>responses<span style='color:#800080; '>;</span>
  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Entering the TTL loop.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>
  <span style='color:#800000; font-weight:bold; '>while</span><span style='color:#808030; '>(</span>number_of_responses <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>2</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> current_ttl <span style='color:#808030; '>&lt;</span> max_ttl<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Main loop over the ttl.</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>TTL = </span><span style='color:#0f69ff; '>%d</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> current_ttl<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    responses <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>*</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#603000; '>malloc</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>*</span>number<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> iTarget<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> iResponse<span style='color:#800080; '>;</span>
    current_ttl<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
    number_of_responses <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Entering the target loop.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>iTarget <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> iTarget <span style='color:#808030; '>&lt;</span> number<span style='color:#800080; '>;</span> iTarget<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>// Loop over the targets</span>
      <span style='color:#800000; font-weight:bold; '>char</span> curTarget<span style='color:#808030; '>[</span>INET_ADDRSTRLEN<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
      probe_desc probe_d<span style='color:#800080; '>;</span>
      probe_response probe_r<span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>int</span> try_counter <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>int</span> already_known <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
      pickTarget<span style='color:#808030; '>(</span>curTarget<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>  <span style='color:#696969; '>// Picks a random, valid IP address as a target</span>
      <span style='color:#696969; '>/* Prepare the probe_desc struct to be passed to the send_udp_probe function */</span>
      probe_d<span style='color:#808030; '>.</span>udp_sock <span style='color:#808030; '>=</span> udp_sock<span style='color:#800080; '>;</span>
      probe_d<span style='color:#808030; '>.</span>icmp_sock <span style='color:#808030; '>=</span> icmp_sock<span style='color:#800080; '>;</span>
      probe_d<span style='color:#808030; '>.</span>port <span style='color:#808030; '>=</span> port<span style='color:#800080; '>;</span>
      probe_d<span style='color:#808030; '>.</span>ttl <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>uint8_t<span style='color:#808030; '>)</span>current_ttl<span style='color:#800080; '>;</span>
      <span style='color:#603000; '>sprintf</span><span style='color:#808030; '>(</span>probe_d<span style='color:#808030; '>.</span>msg<span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%s</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      ms_to_timespec<span style='color:#808030; '>(</span>timeout_ms<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>probe_d<span style='color:#808030; '>.</span>timeout_t<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Sending probe: TTL=</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>, target=</span><span style='color:#0f69ff; '>%s</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> current_ttl<span style='color:#808030; '>,</span> curTarget<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
      <span style='color:#800000; font-weight:bold; '>while</span><span style='color:#808030; '>(</span>send_udp_probe<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>probe_d<span style='color:#808030; '>,</span> curTarget<span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>   <span style='color:#696969; '>// Tries to send the UDP probe</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Sending attempt failed. (</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>)</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>try_counter<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Probe sent, waiting for responses.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
      recv_udp_response<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>probe_d<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>probe_r<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>// Waits for a response (up to the specified timeout)</span>
      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>probe_r<span style='color:#808030; '>.</span>r_type <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> TTL_EXPIRED<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>TTL Expired: </span><span style='color:#0f69ff; '>%s</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> probe_r<span style='color:#808030; '>.</span>r_addr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>iResponse <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> iResponse <span style='color:#808030; '>&lt;</span> number_of_responses<span style='color:#800080; '>;</span> iResponse<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#603000; '>strcmp</span><span style='color:#808030; '>(</span>responses<span style='color:#808030; '>[</span>iResponse<span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> probe_r<span style='color:#808030; '>.</span>r_addr<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        already_known <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>already_known<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>New response: </span><span style='color:#0f69ff; '>%s</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> probe_r<span style='color:#808030; '>.</span>r_addr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
      responses<span style='color:#808030; '>[</span>number_of_responses<span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#603000; '>malloc</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>)</span><span style='color:#808030; '>*</span>INET_ADDRSTRLEN<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#603000; '>sprintf</span><span style='color:#808030; '>(</span>responses<span style='color:#808030; '>[</span>number_of_responses<span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%s</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> probe_r<span style='color:#808030; '>.</span>r_addr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      number_of_responses<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Response already known: </span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> probe_r<span style='color:#808030; '>.</span>r_addr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
      <span style='color:#800080; '>}</span>
      <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Timeout (No response)</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
      <span style='color:#800080; '>}</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stdout</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> </span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '> </span><span style='color:#0f69ff; '>%s</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> current_ttl<span style='color:#808030; '>,</span> iTarget<span style='color:#808030; '>,</span> curTarget<span style='color:#808030; '>,</span> probe_r<span style='color:#808030; '>.</span>r_addr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Exiting the target loop, </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> response(s) for TTL </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> number_of_responses<span style='color:#808030; '>,</span> current_ttl<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>iResponse <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> iResponse <span style='color:#808030; '>&lt;</span> number_of_responses<span style='color:#800080; '>;</span> iResponse<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#603000; '>free</span><span style='color:#808030; '>(</span>responses<span style='color:#808030; '>[</span>iResponse<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#603000; '>free</span><span style='color:#808030; '>(</span>responses<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>

  <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>verbose<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#603000; '>fprintf</span><span style='color:#808030; '>(</span><span style='color:#603000; '>stderr</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>Exiting the TTL loop.</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
  <span style='color:#800080; '>}</span>


  <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>